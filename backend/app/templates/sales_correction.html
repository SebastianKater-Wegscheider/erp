<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <title>Rechnungskorrektur {{ correction_number }}</title>
  </head>
  <body>
    {% set show_vat = has_regular_lines and company_vat_id and not company_small_business_notice %}

    <header class="letterhead">
      <div class="lh-left">
        <div class="lh-name">{{ company_name }}</div>
        <div class="lh-address preline">{{ company_address }}</div>
      </div>
      <div class="lh-right">
        {% if company_logo_path %}<img class="lh-logo" src="{{ company_logo_path }}" alt="Logo" />{% endif %}
        {% if company_email %}<div>{{ company_email }}</div>{% endif %}
        {% if company_vat_id %}<div>UID: {{ company_vat_id }}</div>{% endif %}
      </div>
    </header>

    <div class="letter-grid">
      <div class="recipient">
        <div class="small muted">Kunde</div>
        <div class="recipient-name">{{ buyer_name }}</div>
        {% if buyer_address %}
          <div class="recipient-address preline">{{ buyer_address }}</div>
        {% endif %}
      </div>

      <div class="meta">
        <table class="meta-table">
          <tr>
            <td>Korrektur-Nr.</td>
            <td class="right mono">{{ correction_number }}</td>
          </tr>
          <tr>
            <td>Datum</td>
            <td class="right">{{ correction_date }}</td>
          </tr>
          <tr>
            <td>Bezug</td>
            <td class="right mono">Rechnung {{ invoice_number }}</td>
          </tr>
          <tr>
            <td>Kanal</td>
            <td class="right">{{ channel }}</td>
          </tr>
        </table>
      </div>
    </div>

    <div class="subject-tag">Korrektur</div>
    <div class="subject">Rechnungskorrektur / Storno</div>
    <div class="subline">
      Dieser Beleg korrigiert die Rechnung {{ invoice_number }}. Alle Beträge sind als Korrekturwerte ausgewiesen.
    </div>

    {% if show_vat %}
      <table class="items">
        <thead>
          <tr>
            <th class="col-pos">Pos</th>
            <th>Artikel</th>
            <th class="right col-qty">Menge</th>
            <th class="right col-money">Netto (EUR)</th>
            <th class="right col-money">USt (EUR)</th>
            <th class="right col-money">Brutto (EUR)</th>
          </tr>
        </thead>
        <tbody>
          {% for line in lines %}
            <tr>
              <td class="col-pos">{{ loop.index }}</td>
              <td>
                <div><strong>{{ line.title }}</strong></div>
                <div class="line-meta">
                  {{ line.platform }} · {{ line.region }}{% if line.variant %} · {{ line.variant }}{% endif %}
                  {% if line.purchase_type == "DIFF" %} · Differenzbesteuerung{% endif %}
                </div>
                <div class="line-action {{ line.action_class }}">Retourenentscheidung: {{ line.action_label }}</div>
              </td>
              <td class="right col-qty">1</td>
              <td class="right col-money">{{ line.net_eur or "" }}</td>
              <td class="right col-money">{{ line.tax_eur or "" }}</td>
              <td class="right col-money">{{ line.gross_eur }}</td>
            </tr>
          {% endfor %}

          {% if shipping_refund_regular_gross_cents > 0 %}
            <tr>
              <td class="col-pos"></td>
              <td>Versand (Korrektur)</td>
              <td class="right col-qty"></td>
              <td class="right col-money">{{ shipping_refund_regular_net_eur }}</td>
              <td class="right col-money">{{ shipping_refund_regular_tax_eur }}</td>
              <td class="right col-money">{{ shipping_refund_regular_gross_eur }}</td>
            </tr>
          {% endif %}

          {% if shipping_refund_margin_gross_cents > 0 %}
            <tr>
              <td class="col-pos"></td>
              <td>Versand (Korrektur, Differenzbesteuerung)</td>
              <td class="right col-qty"></td>
              <td class="right col-money"></td>
              <td class="right col-money"></td>
              <td class="right col-money">{{ shipping_refund_margin_gross_eur }}</td>
            </tr>
          {% endif %}
        </tbody>
      </table>

      <div class="totals-wrap">
        <table class="totals-table">
          {% if has_diff_lines %}
            <tr>
              <td class="label">Summe regelbesteuert (Netto)</td>
              <td class="right mono">{{ regular_total_net_eur }}</td>
            </tr>
            <tr>
              <td class="label">Umsatzsteuer (20%)</td>
              <td class="right mono">{{ regular_total_tax_eur }}</td>
            </tr>
            <tr>
              <td class="label">Summe regelbesteuert (Brutto)</td>
              <td class="right mono">{{ regular_total_gross_eur }}</td>
            </tr>
            <tr>
              <td class="label">Summe differenzbesteuert</td>
              <td class="right mono">{{ margin_total_gross_eur }}</td>
            </tr>
            <tr class="total-row">
              <td>Gesamt (Korrektur)</td>
              <td class="right mono">{{ total_gross_eur }}</td>
            </tr>
          {% else %}
            <tr>
              <td class="label">Netto (Korrektur)</td>
              <td class="right mono">{{ regular_total_net_eur }}</td>
            </tr>
            <tr>
              <td class="label">Umsatzsteuer (20%)</td>
              <td class="right mono">{{ regular_total_tax_eur }}</td>
            </tr>
            <tr class="total-row">
              <td>Gesamt (Korrektur)</td>
              <td class="right mono">{{ regular_total_gross_eur }}</td>
            </tr>
          {% endif %}
        </table>
      </div>
    {% else %}
      <table class="items">
        <thead>
          <tr>
            <th class="col-pos">Pos</th>
            <th>Artikel</th>
            <th class="right col-qty">Menge</th>
            <th class="right col-money">Brutto (EUR)</th>
          </tr>
        </thead>
        <tbody>
          {% for line in lines %}
            <tr>
              <td class="col-pos">{{ loop.index }}</td>
              <td>
                <div><strong>{{ line.title }}</strong></div>
                <div class="line-meta">
                  {{ line.platform }} · {{ line.region }}{% if line.variant %} · {{ line.variant }}{% endif %}
                  {% if company_vat_id and not company_small_business_notice %} · Differenzbesteuerung{% endif %}
                </div>
                <div class="line-action {{ line.action_class }}">Retourenentscheidung: {{ line.action_label }}</div>
              </td>
              <td class="right col-qty">1</td>
              <td class="right col-money">{{ line.gross_eur }}</td>
            </tr>
          {% endfor %}

          {% if shipping_refund_gross_cents > 0 %}
            <tr>
              <td class="col-pos"></td>
              <td>Versand (Korrektur)</td>
              <td class="right col-qty"></td>
              <td class="right col-money">{{ shipping_refund_gross_eur }}</td>
            </tr>
          {% endif %}
        </tbody>
      </table>

      <div class="totals-wrap">
        <table class="totals-table">
          <tr class="total-row">
            <td>Gesamt (Korrektur)</td>
            <td class="right mono">{{ total_gross_eur }}</td>
          </tr>
        </table>
      </div>
    {% endif %}

    <footer class="doc-footer">
      <div>
        <strong>Impressum</strong>: {{ company_name }} · <span class="preline">{{ company_address }}</span>
        {% if company_email %} · {{ company_email }}{% endif %}
        {% if company_vat_id %} · UID: {{ company_vat_id }}{% endif %}
      </div>
      {% if company_small_business_notice %}
        <div>{{ company_small_business_notice }}</div>
      {% endif %}
      {% if has_diff_lines and company_vat_id and not company_small_business_notice %}
        <div>Hinweis: Differenzbesteuerung gem. § 24 UStG – keine Umsatzsteuer-Ausweisung für differenzbesteuerte Positionen.</div>
      {% endif %}
      <div>Hinweis: Dieser Beleg korrigiert die oben genannte Rechnung.</div>
    </footer>
  </body>
</html>
